# Provenance Service

Lightweight implementation of the Synapse Activity services, based on the PROV spec.

## Overview

This is an OpenAPI-enabled (and documented) Flask server. This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask. The [MongoEngine](https://github.com/MongoEngine/mongoengine) ODM library for Python is used to manage operations between RESTful API requests/responses and a MongoDB database. Additionally, the [Graphene-Mongo](https://github.com/graphql-python/graphene-mongo) library enables integration of MongoEngine with [Graphene](https://github.com/graphql-python/graphene) to provide a GraphQL endpoint.

## Requirements

Python 3.5.2+

You should have a local installation of MongoDB (tested with 4.0.8) with a connection to a database named `provDB`. See [this tutorial](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-os-x/) for getting set up with MongoDB on MacOS using `brew`.

## Usage

To run the server, please execute the following from the root directory:

```
pip install -r requirements.txt
pip install .
```

and open your browser to here:

```
http://localhost:8080/rest/ui/
```

Your OpenAPI definition lives here:

```
http://localhost:8080/rest/openapi.json
```

You can reach the GraphQL interface here:

http://localhost:8080/graphql/

To launch the integration tests, use tox:
```
sudo pip install tox
tox
```

## Running with Docker

To run the server on a Docker container, please execute the following from the root directory:

> **Note:** In order to use the server container, which requires a MongoDB database connection, you should have [Docker Compose](https://docs.docker.com/compose/overview/) installed.

```bash
docker-compose up --build
```

After running this command, the URLs in the previous section should work.

## Development

This server was originally generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the [OpenAPI-Spec](https://openapis.org) from a remote server, you can easily generate a server stub.  

Starting with the Synapse Activity API specification in a `swagger.yaml`, the contents of this repo were generated with the following command:

```
npx openapi-generator generate -i swagger.yaml -g python-flask -DpackageName=synprov -o prov-service/
```

After editing the OpenAPI YAML spec, controller and model code were iteratively regenerated with the following command:

```
npx openapi-generator generate -i synprov/openapi/openapi.yaml -g python-flask -c .openapi-generator-config
```

> **Note:** with the API spec now relatively stable, this process has been deprecated in favor of manually keeping the code and documentation in sync â€” `openapi-generator` will overwrite all controller code, in addition to updating models, which isn't as helpful with working methods in place.
